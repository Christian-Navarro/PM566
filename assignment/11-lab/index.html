<!DOCTYPE html>
<html lang="en-us" 
      xmlns:og="http://ogp.me/ns#" 
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="Grab lab file using command line:
# Step 1 cd ~/Documents mkdir lab11 cd lab11 # Step 2 wget https://raw.githubusercontent.com/USCbiostats/PM566/master/website/content/assignment/11-lab.Rmd  And remember to set eval=TRUE
Learning Goals  Read in and process the COVID dataset from the New York Times GitHub repository Create interactive graphs of different types using plot_ly() and ggplotly() functions Customize the hoverinfo and other plot features Create a Choropleth map using plot_geo()   Lab Description We will work with COVID data downloaded from the New York Times.">

  
  <link rel="alternate" hreflang="en-us" href="https://uscbiostats.github.io/PM566/assignment/11-lab/">

  


  
  
  
  <meta name="theme-color" content="#098A9C">
  

  
  
  
  <script src="/PM566/js/mathjax-config.js"></script>
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i&display=swap">
    
  

  
  
  
  
  <link rel="stylesheet" href="/PM566/css/academic.css">

  




  


  
  

  

  <link rel="manifest" href="/PM566/index.webmanifest">
  <link rel="icon" type="image/png" href="/PM566/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/PM566/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="https://uscbiostats.github.io/PM566/assignment/11-lab/">

  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@USCBiostat">
  <meta property="twitter:creator" content="@USCBiostat">
  
  <meta property="og:site_name" content="Introduction to Health Data Science - PM 566">
  <meta property="og:url" content="https://uscbiostats.github.io/PM566/assignment/11-lab/">
  <meta property="og:title" content="Lab 11 - Interactive Visualization | Introduction to Health Data Science - PM 566">
  <meta property="og:description" content="Grab lab file using command line:
# Step 1 cd ~/Documents mkdir lab11 cd lab11 # Step 2 wget https://raw.githubusercontent.com/USCbiostats/PM566/master/website/content/assignment/11-lab.Rmd  And remember to set eval=TRUE
Learning Goals  Read in and process the COVID dataset from the New York Times GitHub repository Create interactive graphs of different types using plot_ly() and ggplotly() functions Customize the hoverinfo and other plot features Create a Choropleth map using plot_geo()   Lab Description We will work with COVID data downloaded from the New York Times."><meta property="og:image" content="https://uscbiostats.github.io/PM566/img/social-image.png">
  <meta property="twitter:image" content="https://uscbiostats.github.io/PM566/img/social-image.png"><meta property="og:locale" content="en-us">
  
    
    
  

  



  


  


  <link rel="shortcut icon" href="https://uscbiostats.github.io/PM566/favicon.ico" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://uscbiostats.github.io/PM566/img/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://uscbiostats.github.io/PM566/img/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://uscbiostats.github.io/PM566/img/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://uscbiostats.github.io/PM566/img/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://uscbiostats.github.io/PM566/img/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://uscbiostats.github.io/PM566/img/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="https://uscbiostats.github.io/PM566/img/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="https://uscbiostats.github.io/PM566/img/favicon-16x16.png" sizes="16x16" />
  <meta name="application-name" content="PM566: Introduction to Health Data Science - PM 566" />
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta name="msapplication-TileImage" content="https://uscbiostats.github.io/PM566/img/mstile-144x144.png" />


  <title>Lab 11 - Interactive Visualization | Introduction to Health Data Science - PM 566</title>

</head>


<body id="top" data-spy="scroll" data-offset="70"
    data-target="#TableOfContents"
    >

    <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


    









<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/PM566/">Introduction to Health Data Science - PM 566</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/PM566/">Introduction to Health Data Science - PM 566</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/PM566/syllabus/"><span>Syllabus</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/PM566/schedule/"><span>Schedule</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/PM566/reference/"><span>Reference</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      

      

    </ul>

  </div>
</nav>


    <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Lab 11 - Interactive Visualization</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    January 1, 0001
  </span>
  

  

  

  
  
  

  
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      


<p>Grab lab file using command line:</p>
<pre class="sh"><code># Step 1
cd ~/Documents
mkdir lab11
cd lab11

# Step 2
wget https://raw.githubusercontent.com/USCbiostats/PM566/master/website/content/assignment/11-lab.Rmd
</code></pre>
<p><strong>And remember to set <code>eval=TRUE</code></strong></p>
<div id="learning-goals" class="section level1">
<h1>Learning Goals</h1>
<ul>
<li>Read in and process the COVID dataset from the New York Times GitHub repository</li>
<li>Create interactive graphs of different types using <code>plot_ly()</code> and <code>ggplotly()</code> functions</li>
<li>Customize the hoverinfo and other plot features</li>
<li>Create a Choropleth map using <code>plot_geo()</code></li>
</ul>
</div>
<div id="lab-description" class="section level1">
<h1>Lab Description</h1>
<p>We will work with COVID data downloaded from the New York Times. The dataset consists of COVID-19 cases and deaths in each US state during the course of the COVID epidemic.</p>
<p><strong>The objective of this lab is to explore relationships between cases, deaths, and population sizes of US states, and plot data to demonstrate this</strong></p>
</div>
<div id="steps" class="section level1">
<h1>Steps</h1>
<div id="i.-reading-and-processing-the-new-york-times-nyt-state-level-covid-19-data" class="section level2">
<h2>I. Reading and processing the New York Times (NYT) state-level COVID-19 data</h2>
<div id="read-in-the-data" class="section level3">
<h3>1. Read in the data</h3>
<ul>
<li>Read in the COVID data with data.table:fread() from the NYT GitHub repository: “<a href="https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv" class="uri">https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv</a>”</li>
<li>Read in the state population data with data.table:fread() from the repository: “<a href="https://raw.githubusercontent.com/COVID19Tracking/associated-data/master/us_census_data/us_census_2018_population_estimates_states.csv" class="uri">https://raw.githubusercontent.com/COVID19Tracking/associated-data/master/us_census_data/us_census_2018_population_estimates_states.csv</a>””</li>
<li>Merge datasets</li>
</ul>
<pre class="r"><code>## data extracted from New York Times state-level data from NYT Github repository
# https://github.com/nytimes/covid-19-data

## state-level population information from us_census_data available on GitHub repository:
# https://github.com/COVID19Tracking/associated-data/tree/master/us_census_data

### FINISH THE CODE HERE ###
# load COVID state-level data from NYT
cv_states &lt;- as.data.frame(______________(&quot;https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv&quot;))

### FINISH THE CODE HERE ###
# load state population data
state_pops &lt;- as.data.frame(_____________(&quot;https://raw.githubusercontent.com/COVID19Tracking/associated-data/master/us_census_data/us_census_2018_population_estimates_states.csv&quot;))
state_pops$abb &lt;- state_pops$state
state_pops$state &lt;- state_pops$state_name
state_pops$state_name &lt;- NULL

### FINISH THE CODE HERE
cv_states &lt;- merge(cv_states, state_pops, by=________)</code></pre>
</div>
<div id="look-at-the-data" class="section level3">
<h3>2. Look at the data</h3>
<ul>
<li>Inspect the dimensions, <code>head</code>, and <code>tail</code> of the data</li>
<li>Inspect the structure of each variables. Are they in the correct format?</li>
</ul>
<pre class="r"><code>dim(cv_states)
head(cv_states)
tail(cv_states)
str(cv_states)</code></pre>
</div>
<div id="format-the-data" class="section level3">
<h3>3. Format the data</h3>
<ul>
<li>Make date into a date variable</li>
<li>Make state into a factor variable</li>
<li>Order the data first by state, second by date</li>
<li>Confirm the variables are now correctly formatted</li>
<li>Inspect the range values for each variable. What is the date range? The range of cases and deaths?</li>
</ul>
<pre class="r"><code># format the date
cv_states$date &lt;- as.Date(cv_states$date, format=&quot;%Y-%m-%d&quot;)

# format the state and state abbreviation (abb) variables
state_list &lt;- unique(cv_states$state)
cv_states$state &lt;- factor(cv_states$state, levels = state_list)
abb_list &lt;- unique(cv_states$abb)
cv_states$abb &lt;- factor(cv_states$abb, levels = abb_list)

### FINISH THE CODE HERE 
# order the data first by state, second by date
cv_states = cv_states[order(_________, _________),]

# Confirm the variables are now correctly formatted
str(cv_states)
head(cv_states)
tail(cv_states)

# Inspect the range values for each variable. What is the date range? The range of cases and deaths?
head(cv_states)
summary(cv_states)
min(cv_states$date)
max(cv_states$date)</code></pre>
</div>
<div id="add-new_cases-and-new_deaths-and-correct-outliers" class="section level3">
<h3>4. Add <code>new_cases</code> and <code>new_deaths</code> and correct outliers</h3>
<ul>
<li><p>Add variables for new cases, <code>new_cases</code>, and new deaths, <code>new_deaths</code>:</p>
<ul>
<li>Hint: You can set <code>new_cases</code> equal to the difference between cases on date i and date i-1, starting on date i=2</li>
</ul></li>
<li><p>Filter to dates after June 1, 2021</p></li>
<li><p>Use <code>plotly</code> for EDA: See if there are outliers or values that don’t make sense for <code>new_cases</code> and <code>new_deaths</code>. Which states and which dates have strange values?</p></li>
<li><p>Correct outliers: Set negative values for <code>new_cases</code> or <code>new_deaths</code> to 0</p></li>
<li><p>Recalculate <code>cases</code> and <code>deaths</code> as cumulative sum of updated <code>new_cases</code> and <code>new_deaths</code></p></li>
<li><p>Get the rolling average of new cases and new deaths to smooth over time</p></li>
<li><p>Inspect data again interactively</p></li>
</ul>
<pre class="r"><code># Add variables for new_cases and new_deaths:
for (i in 1:length(state_list)) {
  cv_subset = subset(cv_states, state == state_list[i])
  cv_subset = cv_subset[order(cv_subset$date),]

  # add starting level for new cases and deaths
  cv_subset$new_cases = cv_subset$cases[1]
  cv_subset$new_deaths = cv_subset$deaths[1]

  ### FINISH THE CODE HERE
  for (j in 2:nrow(cv_subset)) {
    cv_subset$new_cases[j] = __________ - __________
    cv_subset$new_deaths[j] = __________ - __________
  }

  # include in main dataset
  cv_states$new_cases[cv_states$state==state_list[i]] = cv_subset$new_cases
  cv_states$new_deaths[cv_states$state==state_list[i]] = cv_subset$new_deaths
}

# Focus on recent dates
cv_states &lt;- cv_states %&gt;% dplyr::filter(date &gt;= &quot;2021-06-01&quot;)

### FINISH THE CODE HERE
# Inspect outliers in new_cases using plotly
p1&lt;-ggplot(cv_states, aes(x = date, y = new_cases, color = state)) + ________ + geom_point(size = .5, alpha = 0.5)
ggplotly(p1)
p1&lt;-NULL # to clear from workspace

p2&lt;-ggplot(cv_states, aes(x = date, y = new_deaths, color = state)) + ________ + geom_point(size = .5, alpha = 0.5)
ggplotly(p2)
p2&lt;-NULL # to clear from workspace

# set negative new case or death counts to 0
cv_states$new_cases[cv_states$new_cases&lt;0] = 0
cv_states$new_deaths[cv_states$new_deaths&lt;0] = 0

# Recalculate `cases` and `deaths` as cumulative sum of updated `new_cases` and `new_deaths`
for (i in 1:length(state_list)) {
  cv_subset = subset(cv_states, state == state_list[i])

  # add starting level for new cases and deaths
  cv_subset$cases = cv_subset$cases[1]
  cv_subset$deaths = cv_subset$deaths[1]

  ### FINISH CODE HERE
  for (j in 2:nrow(cv_subset)) {
    cv_subset$cases[j] = cv_subset$new_cases[j] + cv_subset$_________
    cv_subset$deaths[j] = cv_subset$new_deaths[j] + cv_subset$__________
  }
  # include in main dataset
  cv_states$cases[cv_states$state==state_list[i]] = cv_subset$cases
  cv_states$deaths[cv_states$state==state_list[i]] = cv_subset$deaths
}

# Smooth new counts
cv_states$new_cases = zoo::rollmean(cv_states$new_cases, k=7, fill=NA, align=&#39;right&#39;) %&gt;% round(digits = 0)
cv_states$new_deaths = zoo::rollmean(cv_states$new_deaths, k=7, fill=NA, align=&#39;right&#39;) %&gt;% round(digits = 0)

# Inspect data again interactively
p2&lt;-ggplot(cv_states, aes(x = date, y = new_deaths, color = state)) + geom_line() + geom_point(size = .5, alpha = 0.5)
ggplotly(p2)
#p2=NULL</code></pre>
</div>
<div id="add-additional-variables" class="section level3">
<h3>5. Add additional variables</h3>
<ul>
<li><p>Add population-normalized (by 100,000) variables for each variable type (rounded to 1 decimal place). Make sure the variables you calculate are in the correct format (<code>numeric</code>). You can use the following variable names:</p>
<ul>
<li><code>per100k</code> = cases per 100,000 population</li>
<li><code>newper100k</code>= new cases per 100,000</li>
<li><code>deathsper100k</code> = deaths per 100,000</li>
<li><code>newdeathsper100k</code> = new deaths per 100,000</li>
</ul></li>
<li><p>Add a “naive CFR” variable representing <code>deaths / cases</code> on each date for each state</p></li>
<li><p>Create a dataframe representing values on the most recent date, <code>cv_states_today</code>, as done in lecture</p></li>
</ul>
<pre class="r"><code>### FINISH CODE HERE
# add population normalized (by 100,000) counts for each variable
cv_states$per100k =  as.numeric(format(round(cv_states$cases/(cv_states$________/100000),1),nsmall=1))
cv_states$newper100k =  as.numeric(format(round(cv_states$new_cases/(cv_states$________/100000),1),nsmall=1))
cv_states$deathsper100k =  as.numeric(format(round(cv_states$deaths/(cv_states$________/100000),1),nsmall=1))
cv_states$newdeathsper100k =  as.numeric(format(round(cv_states$new_deaths/(cv_states$________/100000),1),nsmall=1))

# add a naive_CFR variable = deaths / cases
cv_states = cv_states %&gt;% mutate(naive_CFR = round((deaths*100/cases),2))

# create a `cv_states_today` variable
cv_states_today = subset(cv_states, date==max(cv_states$date))</code></pre>
</div>
</div>
<div id="ii.-scatterplots" class="section level2">
<h2>II. Scatterplots</h2>
<div id="explore-scatterplots-using-plot_ly" class="section level3">
<h3>6. Explore scatterplots using <code>plot_ly()</code></h3>
<ul>
<li>Create a scatterplot using <code>plot_ly()</code> representing <code>pop_density</code> vs. various variables (e.g. <code>cases</code>, <code>per100k</code>, <code>deaths</code>, <code>deathsper100k</code>) for each state on most recent date (<code>cv_states_today</code>)
<ul>
<li>Color points by state and size points by state population</li>
<li>Use hover to identify any outliers.</li>
<li>Remove those outliers and replot.</li>
</ul></li>
<li>Choose one plot. For this plot:
<ul>
<li>Add hoverinfo specifying the state name, cases per 100k, and deaths per 100k, similarly to how we did this in the lecture notes</li>
<li>Add layout information to title the chart and the axes</li>
<li>Enable <code>hovermode = "compare"</code></li>
</ul></li>
</ul>
<pre class="r"><code>### FINISH CODE HERE

# pop_density vs. cases
cv_states_today %&gt;% 
  plot_ly(x = ~pop_density, y = ~cases, 
          type = _______, mode = &#39;markers&#39;, color = ~______,
          size = ~population, sizes = c(5, 70), marker = list(sizemode=&#39;diameter&#39;, opacity=0.5))

# filter out &quot;District of Columbia&quot;
cv_states_today_filter &lt;- cv_states_today %&gt;% filter(state!=&quot;District of Columbia&quot;)

# pop_density vs. cases after filtering
cv_states_today_filter %&gt;% 
  plot_ly(x = ~pop_density, y = ~cases, 
          type = _______, mode = &#39;markers&#39;, color = ~_______,
          size = ~population, sizes = c(5, 70), marker = list(sizemode=&#39;diameter&#39;, opacity=0.5))

# pop_density vs. deathsper100k
cv_states_today_filter %&gt;% 
  plot_ly(x = ~pop_density, y = ~deathsper100k,
          type = _______, mode = &#39;markers&#39;, color = ~_______,
          size = ~population, sizes = c(5, 70), marker = list(sizemode=&#39;diameter&#39;, opacity=0.5))

# Adding hoverinfo
cv_states_today_filter %&gt;% 
  plot_ly(x = ~pop_density, y = ~deathsper100k,
          type = _______, mode = &#39;markers&#39;, color = ~_______,
          size = ~population, sizes = c(5, 70), marker = list(sizemode=&#39;diameter&#39;, opacity=0.5),
          hoverinfo = &#39;text&#39;,
          text = ~paste( paste(state, &quot;:&quot;, sep=&quot;&quot;), paste(&quot; Cases per 100k: &quot;, per100k, sep=&quot;&quot;) , 
                         paste(&quot; Deaths per 100k: &quot;, _______, sep=&quot;&quot;), sep = &quot;&lt;br&gt;&quot;)) %&gt;%
  layout(title = &quot;Population-normalized COVID-19 deaths (per 100k) vs. population density for US states&quot;,
                  yaxis = list(title = &quot;Deaths per 100k&quot;), xaxis = list(title = &quot;Population Density&quot;),
         hovermode = &quot;compare&quot;)</code></pre>
</div>
<div id="explore-scatterplot-trend-interactively-using-ggplotly-and-geom_smooth" class="section level3">
<h3>7. Explore scatterplot trend interactively using <code>ggplotly()</code> and <code>geom_smooth()</code></h3>
<ul>
<li>For <code>pop_density</code> vs. <code>newdeathsper100k</code> create a chart with the same variables using <code>gglot_ly()</code></li>
<li>Explore the pattern between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> using <code>geom_smooth()</code>
<ul>
<li>Explain what you see. Do you think <code>pop_density</code> is a correlate of <code>newdeathsper100k</code>?</li>
</ul></li>
</ul>
<pre class="r"><code>### FINISH CODE HERE
p &lt;- ggplot(cv_states_today_scatter, aes(x=pop_density, y=deathsper100k, size=population)) + geom_point() + _______
ggplotly(p)</code></pre>
</div>
<div id="multiple-line-chart" class="section level3">
<h3>8. Multiple line chart</h3>
<ul>
<li>Create a line chart of the <code>naive_CFR</code> for all states over time using <code>plot_ly()</code>
<ul>
<li>Use the zoom and pan tools to inspect the <code>naive_CFR</code> for the states that had an increase in September. How have they changed over time?</li>
</ul></li>
<li>Create one more line chart, for Florida only, which shows <code>new_cases</code> and <code>new_deaths</code> together in one plot. Hint: use <code>add_layer()</code>
<ul>
<li>Use hoverinfo to “eyeball” the approximate peak of deaths and peak of cases. What is the time delay between the peak of cases and the peak of deaths?</li>
</ul></li>
</ul>
<pre class="r"><code>### FINISH CODE HERE
# Line chart for naive_CFR for all states over time using `plot_ly()`
plot_ly(cv_states, x = ~date, y = ~_______, color = ~state, type = &quot;scatter&quot;, mode = &quot;lines&quot;)

### FINISH CODE HERE
# Line chart for Florida showing new_cases and new_deaths together
cv_states %&gt;% filter(state==&quot;Florida&quot;) %&gt;% plot_ly(x = ~date, y = ~new_cases, type = &quot;scatter&quot;, mode = &quot;lines&quot;) %&gt;% _______(x = ~date, y = ~new_deaths, type = &quot;scatter&quot;, mode = &quot;lines&quot;) </code></pre>
</div>
<div id="heatmaps" class="section level3">
<h3>9. Heatmaps</h3>
<p>Create a heatmap to visualize <code>new_cases</code> for each state on each date greater than June 1st, 2021
- Start by mapping selected features in the dataframe into a matrix using the <strong>tidyr</strong> package function <code>pivot_wider()</code>, naming the rows and columns, as done in the lecture notes
- Use <code>plot_ly()</code> to create a heatmap out of this matrix. Which states stand out?
- Repeat with <code>newper100k</code> variable. Now which states stand out?
- Create a second heatmap in which the pattern of <code>new_cases</code> for each state over time becomes more clear by filtering to only look at dates every two weeks</p>
<pre class="r"><code>### FINISH CODE HERE
# Map state, date, and new_cases to a matrix
library(tidyr)
cv_states_mat &lt;- cv_states %&gt;% select(state, date, new_cases) %&gt;% dplyr::filter(date&gt;as.Date(&quot;2021-06-15&quot;))
cv_states_mat2 &lt;- as.data.frame(pivot_wider(cv_states_mat, names_from = state, values_from = ________))
rownames(cv_states_mat2) &lt;- cv_states_mat2$date
cv_states_mat2$date &lt;- NULL
cv_states_mat2 &lt;- as.matrix(cv_states_mat2)

# Create a heatmap using plot_ly()
plot_ly(x=colnames(cv_states_mat2), y=rownames(cv_states_mat2),
             z=~cv_states_mat2,
             type=&quot;heatmap&quot;,
             showscale=T)

# Repeat with newper100k
cv_states_mat &lt;- cv_states %&gt;% select(state, date, newper100k) %&gt;% dplyr::filter(date&gt;as.Date(&quot;2021-06-15&quot;))
cv_states_mat2 &lt;- as.data.frame(pivot_wider(cv_states_mat, names_from = state, values_from = ________))
rownames(cv_states_mat2) &lt;- cv_states_mat2$date
cv_states_mat2$date &lt;- NULL
cv_states_mat2 &lt;- as.matrix(cv_states_mat2)

plot_ly(x=colnames(cv_states_mat2), y=rownames(cv_states_mat2),
             z=~cv_states_mat2,
             type=&quot;heatmap&quot;,
             showscale=T)

# Create a second heatmap after filtering to only include dates every other week
filter_dates &lt;- seq(as.Date(&quot;2021-06-15&quot;), as.Date(&quot;2021-11-01&quot;), by=________)

cv_states_mat &lt;- cv_states %&gt;% select(state, date, newper100k) %&gt;% filter(date %in% filter_dates)
cv_states_mat2 &lt;- as.data.frame(pivot_wider(cv_states_mat, names_from = state, values_from = ________))
rownames(cv_states_mat2) &lt;- cv_states_mat2$date
cv_states_mat2$date &lt;- NULL
cv_states_mat2 &lt;- as.matrix(cv_states_mat2)

# Create a heatmap using plot_ly()
plot_ly(x=colnames(cv_states_mat2), y=rownames(cv_states_mat2),
             z=~cv_states_mat2,
             type=&quot;heatmap&quot;,
             showscale=T)</code></pre>
</div>
<div id="map" class="section level3">
<h3>10. Map</h3>
<ul>
<li>Create a map to visualize the <code>naive_CFR</code> by state on October 15, 2021</li>
<li>Compare with a map visualizing the <code>naive_CFR</code> by state on most recent date</li>
<li>Plot the two maps together using <code>subplot()</code>. Make sure the shading is for the same range of values (google is your friend for this)</li>
<li>Describe the difference in the pattern of the CFR.</li>
</ul>
<pre class="r"><code>### For specified date

pick.date = &quot;2021-10-15&quot;

# Extract the data for each state by its abbreviation
cv_per100 &lt;- cv_states %&gt;% filter(date==pick.date) %&gt;% select(state, abb, newper100k, cases, deaths) # select data
cv_per100$state_name &lt;- cv_per100$state
cv_per100$state &lt;- cv_per100$abb
cv_per100$abb &lt;- NULL

# Create hover text
cv_per100$hover &lt;- with(cv_per100, paste(state_name, &#39;&lt;br&gt;&#39;, &quot;Cases per 100k: &quot;, newper100k, &#39;&lt;br&gt;&#39;, &quot;Cases: &quot;, cases, &#39;&lt;br&gt;&#39;, &quot;Deaths: &quot;, deaths))

# Set up mapping details
set_map_details &lt;- list(
  scope = &#39;usa&#39;,
  projection = list(type = &#39;albers usa&#39;),
  showlakes = TRUE,
  lakecolor = toRGB(&#39;white&#39;)
)

# Make sure both maps are on the same color scale
shadeLimit &lt;- 125

# Create the map
fig &lt;- plot_geo(cv_per100, locationmode = &#39;USA-states&#39;) %&gt;% 
  add_trace(
    z = ~newper100k, text = ~hover, locations = ~state,
    color = ~newper100k, colors = &#39;Purples&#39;
  )
fig &lt;- fig %&gt;% colorbar(title = paste0(&quot;Cases per 100k: &quot;, pick.date), limits = c(0,shadeLimit))
fig &lt;- fig %&gt;% layout(
    title = paste(&#39;Cases per 100k by State as of &#39;, pick.date, &#39;&lt;br&gt;(Hover for value)&#39;),
    geo = set_map_details
  )
fig_pick.date &lt;- fig

#############
### Map for today&#39;s date

# Extract the data for each state by its abbreviation
cv_per100 &lt;- cv_states_today %&gt;%  select(state, abb, newper100k, cases, deaths) # select data
cv_per100$state_name &lt;- cv_per100$state
cv_per100$state &lt;- cv_per100$abb
cv_per100$abb &lt;- NULL

# Create hover text
cv_per100$hover &lt;- with(cv_per100, paste(state_name, &#39;&lt;br&gt;&#39;, &quot;Cases per 100k: &quot;, newper100k, &#39;&lt;br&gt;&#39;, &quot;Cases: &quot;, cases, &#39;&lt;br&gt;&#39;, &quot;Deaths: &quot;, deaths))

# Set up mapping details
set_map_details &lt;- list(
  scope = &#39;usa&#39;,
  projection = list(type = &#39;albers usa&#39;),
  showlakes = TRUE,
  lakecolor = toRGB(&#39;white&#39;)
)

# Create the map
fig &lt;- plot_geo(cv_per100, locationmode = &#39;USA-states&#39;) %&gt;% 
  add_trace(
    z = ~newper100k, text = ~hover, locations = ~state,
    color = ~newper100k, colors = &#39;Purples&#39;
  )
fig &lt;- fig %&gt;% colorbar(title = paste0(&quot;Cases per 100k: &quot;, Sys.Date()), limits = c(0,shadeLimit))
fig &lt;- fig %&gt;% layout(
    title = paste(&#39;Cases per 100k by State as of&#39;, Sys.Date(), &#39;&lt;br&gt;(Hover for value)&#39;),
    geo = set_map_details
  )
fig_Today &lt;- fig


### Plot together 
________(fig_pick.date, fig_Today, nrows = 2, margin = .05)</code></pre>
</div>
</div>
</div>

    </div>

    















  
  



  </div>
</article>

        

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    

    

    
    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/PM566/js/academic.min.f30a8b5a880e824aab9653942c89109b.js"></script>

    






    
    
    <div class="container">
        <footer>
    <hr>

    <div class="row course-info">
        <div class="col-md-7">
            <p>
                <strong>PM566: Introduction to Health Data Science - PM 566 (Fall 2023)</strong><br>
            </p>
            <p>
                <a href="https://www.usc.edu/" target="_blank" rel="noopener">University of Southern California</a>
            </p>
            <p>
                <a href="https://pphs.usc.edu/" target="_blank" rel="noopener">Department of Population and Public Health Sciences</a>
            </p>
            <p>
                <a><i class="fas fa-user"></i>
                    Kelly Street</a>
            </p>
            <p>
                <a href="mailto:kelly.street@usc.edu"><i class="fas fa-envelope"></i>
                    kelly.street@usc.edu</a>
            </p>
        </div>

        <div class="col-md-5 credits">
            <p>All content licensed under a <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.</p>                    
            
            <p><a href="https://github.com/USCbiostats/PM566" target="_blank" rel="noopener"><i class="fab fa-github"></i> View the source at GitHub.</a></p>
        </div>
    </div>
</footer>

    </div>
    

    
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>

</html>
