<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Exploratory Data Analysis</title>
    <meta charset="utf-8" />
    <meta name="author" content="Meredith Franklin" />
    <link rel="stylesheet" href="theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, title-slide

# Exploratory Data Analysis
## PM 566: Introduction to Health Data Science
### Meredith Franklin

---


&lt;!--Yeah... I have really long code chunks, so I just changed the default size :)--&gt;
&lt;style type="text/css"&gt;
pre{
  font-size:medium;
}
code.r,code.cpp{
  font-size:large
}
&lt;/style&gt;





# Exploratory Data Analysis

* Exploratory data analysis is the process of summarizing data
* It should be the first step in your analysis pipeline
* It involves:
--

  + checking data (import issues, outliers, missing values, data errors)
  + cleaning data
  + summary statistics of key variables (univariate and bivariate)
  + basic plots and graphs

---
# Pipeline
.center[
![](img/data-science.png)
]

EDA involves Import -&gt; Tidy -&gt; Transform -&gt; Visualize. Basically it is everything before we do modeling, prediction or inference.

---
# EDA Checklist

The goal of EDA is to better understand your data. Let's use the **checklist**:
--

1.  Formulate a question
--

2.  Read in the data
--

3.  Check the dimensions and headers and footers of the data
--

4.  Check the variable types in the data
--

5.  Take a closer look at some/all of the variables
--

6.  Validate with an external source
--

7.  Conduct some summary statistics to answer the initial question
--

8.  Make exploratory graphs

---
# Case study

We are going to use a dataset created from the National Center for Environmental Information (https://www.ncei.noaa.gov/). The data are 2019 hourly measurements from weather stations across the continental U.S.

.center[
![:scale 60%](img/weather.png)
]

---

# Formulate a Question

- It is a good idea to first have a question such as:
--

  * what weather stations reported the hottest and coldest temperatures? 
  * what are the summary statistics of the continuous variables in my dataset (mean, variance)?
  * is there covariation between two variables in my dataset?

---

# Read in the Data

There are several ways to read in data (some depend on the type of data you have):

* `read.table` or `read.csv` in base R for delimited files
* `readRDS` if you have a .rds dataset
* `read_csv`, `read_csv2`, `read_delim`, `read_fwf` from `library(readr)` that is part of the tidyverse
* `readxl()` from `library(readxl)` for .xls and .xlsx files
* `read_sas`, `read_spss`, `read_stata` from `library(haven)`
*  `fread` from `library(data.table)` for efficiently importing large datasets that are regular delimited files 

---

# Read in the Data

We will focus on base R, `data.table` and the `tidyverse`. Let's load the libraries we need to read in the data:

```r
library(data.table)
library(tidyverse)
```
Let's load in the data with `data.table`. I have it stored locally, but we will see how to load it straight from github in the lab.

```r
met = data.table::fread("/Users/meredith/Dropbox (University of Southern California)/Courses/PM566/met_all.gz")
```
---

# Read in the Data

`data.table` is a more efficient version of base R's `data.frame`. We create a `data.table` from an external data source by reading it in using `fread()`

We can convert existing `data.frame` or `list` objects to `data.table` by using `setDT()`

The nice thing about `data.table` is that it handles large datasets efficiently and it never reads/converts character type variables to factors, which can be a pain with `data.frame`

The other nice thing about `data.table` is that many of the base R functions work just as if it was a `data.frame`

---

# Check the data

We should check the dimensions of the data set. This can be done several ways:

```r
dim(met)
```

```
## [1] 2377343      30
```

```r
nrow(met)
```

```
## [1] 2377343
```

```r
ncol(met)
```

```
## [1] 30
```


---

# Check the data

* We see that there are 2,377,343 records of hourly temperature in August 2019 from all of the weather stations in the US. The data set has 30 variables. 
* We should also check the top and bottom of the dataset to make sure that it imported correctly. Use `head(met)` and `tail(met)` for this.
* Next we can take a deeper dive into the contents of the data with `str()`
---


# Check variables

```r
str(met)
```

```
## Classes 'data.table' and 'data.frame':	2377343 obs. of  30 variables:
##  $ USAFID           : int  690150 690150 690150 690150 690150 690150 690150 690150 690150 690150 ...
##  $ WBAN             : int  93121 93121 93121 93121 93121 93121 93121 93121 93121 93121 ...
##  $ year             : int  2019 2019 2019 2019 2019 2019 2019 2019 2019 2019 ...
##  $ month            : int  8 8 8 8 8 8 8 8 8 8 ...
##  $ day              : int  1 1 1 1 1 1 1 1 1 1 ...
##  $ hour             : int  0 1 2 3 4 5 6 7 8 9 ...
##  $ min              : int  56 56 56 56 56 56 56 56 56 56 ...
##  $ lat              : num  34.3 34.3 34.3 34.3 34.3 34.3 34.3 34.3 34.3 34.3 ...
##  $ lon              : num  -116 -116 -116 -116 -116 ...
##  $ elev             : int  696 696 696 696 696 696 696 696 696 696 ...
##  $ wind.dir         : int  220 230 230 210 120 NA 320 10 320 350 ...
##  $ wind.dir.qc      : chr  "5" "5" "5" "5" ...
##  $ wind.type.code   : chr  "N" "N" "N" "N" ...
##  $ wind.sp          : num  5.7 8.2 6.7 5.1 2.1 0 1.5 2.1 2.6 1.5 ...
##  $ wind.sp.qc       : chr  "5" "5" "5" "5" ...
##  $ ceiling.ht       : int  22000 22000 22000 22000 22000 22000 22000 22000 22000 22000 ...
##  $ ceiling.ht.qc    : int  5 5 5 5 5 5 5 5 5 5 ...
##  $ ceiling.ht.method: chr  "9" "9" "9" "9" ...
##  $ sky.cond         : chr  "N" "N" "N" "N" ...
##  $ vis.dist         : int  16093 16093 16093 16093 16093 16093 16093 16093 16093 16093 ...
##  $ vis.dist.qc      : chr  "5" "5" "5" "5" ...
##  $ vis.var          : chr  "N" "N" "N" "N" ...
##  $ vis.var.qc       : chr  "5" "5" "5" "5" ...
##  $ temp             : num  37.2 35.6 34.4 33.3 32.8 31.1 29.4 28.9 27.2 26.7 ...
##  $ temp.qc          : chr  "5" "5" "5" "5" ...
##  $ dew.point        : num  10.6 10.6 7.2 5 5 5.6 6.1 6.7 7.8 7.8 ...
##  $ dew.point.qc     : chr  "5" "5" "5" "5" ...
##  $ atm.press        : num  1010 1010 1011 1012 1013 ...
##  $ atm.press.qc     : int  5 5 5 5 5 5 5 5 5 5 ...
##  $ rh               : num  19.9 21.8 18.5 16.9 17.4 ...
##  - attr(*, ".internal.selfref")=&lt;externalptr&gt;
```
---


# Check variables

* First, we see that `str()` gives us the class of the data, which in this case is both `data.table` and `data.frame`, as well as the dimensions of the data
* We also see the variable names and their type (integer, numeric, character) 
* We can identify major problems with the data at this stage (e.g. a variable that has all missing values)

--

We can get summary statistics on our `data.table` using `summary()` as we would with a regular `data.frame`

---

# Check variables


```r
summary(met[,8:13])
```

```
##       lat             lon               elev           wind.dir     
##  Min.   :24.55   Min.   :-124.29   Min.   : -13.0   Min.   :  3     
##  1st Qu.:33.97   1st Qu.: -98.02   1st Qu.: 101.0   1st Qu.:120     
##  Median :38.35   Median : -91.71   Median : 252.0   Median :180     
##  Mean   :37.94   Mean   : -92.15   Mean   : 415.8   Mean   :185     
##  3rd Qu.:41.94   3rd Qu.: -82.99   3rd Qu.: 400.0   3rd Qu.:260     
##  Max.   :48.94   Max.   : -68.31   Max.   :9999.0   Max.   :360     
##                                                     NA's   :785290  
##  wind.dir.qc        wind.type.code    
##  Length:2377343     Length:2377343    
##  Class :character   Class :character  
##  Mode  :character   Mode  :character  
##                                       
##                                       
##                                       
## 
```
---

# Check variables more closely

We know that we are supposed to have hourly measurements of weather data for the month of August 2019 for the entire US. We should check that we have all of these components. Let us check:

* the year
* the month
* the hours
* the range of locations (latitude and longitude)

---

# Check variables more closely

We can generate tables for integer values

```r
table(met$hour)
```

```
## 
##      0      1      2      3      4      5      6      7      8      9     10 
##  99434  93482  93770  96703 110504 112128 106235 101985 100310 102915 101880 
##     11     12     13     14     15     16     17     18     19     20     21 
## 100470 103605  97004  96507  97635  94942  94184 100179  94604  94928  96070 
##     22     23 
##  94046  93823
```

```r
table(met$month)
```

```
## 
##       8 
## 2377343
```
---

# Check variables more closely

For numeric values we should do a summary to see the quantiles, max, min


```r
table(met$year)
```

```
## 
##    2019 
## 2377343
```

```r
summary(met$lat)
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   24.55   33.97   38.35   37.94   41.94   48.94
```

```r
summary(met$lon)
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## -124.29  -98.02  -91.71  -92.15  -82.99  -68.31
```
---

# Check variables more closely

Let's check some of the weather variables

```r
summary(met$temp)
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##  -40.00   19.60   23.50   23.59   27.80   56.00   60089
```
It looks like the temperatures are in Celcius. A temperature of -40 in August is really cold, we should see if this is an implausiple value.

It also looks like there are a lot of missing data. Let us check the proportion of missings


```r
dim(met[is.na(temp)])[1]/dim(met)[1]
```

```
## [1] 0.0252757
```

---



# Check variables more closely

In `data.table` we can easily subset the data and select certain columns

```r
met_ss = met[temp == -40.00, .(hour, lat, lon, elev, wind.sp)]

dim(met_ss)
```

```
## [1] 36  5
```

```r
summary(met_ss)
```

```
##       hour            lat             lon              elev       wind.sp   
##  Min.   : 0.00   Min.   :29.12   Min.   :-89.55   Min.   :36   Min.   : NA  
##  1st Qu.: 2.75   1st Qu.:29.12   1st Qu.:-89.55   1st Qu.:36   1st Qu.: NA  
##  Median : 5.50   Median :29.12   Median :-89.55   Median :36   Median : NA  
##  Mean   : 5.50   Mean   :29.12   Mean   :-89.55   Mean   :36   Mean   :NaN  
##  3rd Qu.: 8.25   3rd Qu.:29.12   3rd Qu.:-89.55   3rd Qu.:36   3rd Qu.: NA  
##  Max.   :11.00   Max.   :29.12   Max.   :-89.55   Max.   :36   Max.   : NA  
##                                                                NA's   :36
```
---

# Check variables more closely

In `dplyr` we can do the same thing using  `filter` 

```r
met_ss = filter(met, temp == -40.00) %&gt;% 
        select(USAFID, day, hour, 
               lat, lon, elev, wind.sp)

dim(met_ss)
```

```
## [1] 36  7
```

```r
summary(met_ss)
```

```
##      USAFID            day         hour            lat             lon        
##  Min.   :720717   Min.   :1   Min.   : 0.00   Min.   :29.12   Min.   :-89.55  
##  1st Qu.:720717   1st Qu.:1   1st Qu.: 2.75   1st Qu.:29.12   1st Qu.:-89.55  
##  Median :720717   Median :1   Median : 5.50   Median :29.12   Median :-89.55  
##  Mean   :720717   Mean   :1   Mean   : 5.50   Mean   :29.12   Mean   :-89.55  
##  3rd Qu.:720717   3rd Qu.:1   3rd Qu.: 8.25   3rd Qu.:29.12   3rd Qu.:-89.55  
##  Max.   :720717   Max.   :1   Max.   :11.00   Max.   :29.12   Max.   :-89.55  
##                                                                               
##       elev       wind.sp   
##  Min.   :36   Min.   : NA  
##  1st Qu.:36   1st Qu.: NA  
##  Median :36   Median : NA  
##  Mean   :36   Mean   :NaN  
##  3rd Qu.:36   3rd Qu.: NA  
##  Max.   :36   Max.   : NA  
##               NA's   :36
```

---

# Validate against an external source

We should check outside sources to make sure that our data make sense. For example the observation with -40C is suspicious, so we should look up the location of the weather station.

Go to [Google maps](https://www.google.com/maps/) and enter the coordinates for the site with -40C (29.12, -89.55)

.center[
![:scale 40%](img/map.png)
]

It doesn't make much sense to have a -40C reading in the Gulf of Mexico off the coast of Louisiana.
---

# Summary statistics

If we return to our initial question, what weather stations reported the hottest and coldest temperatures? we need to generate a list of weather stations that are ordered from highest to lowest. We can then examine the top and bottom of this new dataset.

In `data.table` 

---
# Exploratory Graphs

* With exploratory graphs we aim to:

--

  + debug any issues remaining in the data
  + understand properties of the data
  + look for patterns in the data
  + inform modeling strategies
  
--- 
# Exploratory Graphs
.center[
![](img/weather_map.png)
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
